{% extends '../../utils/base.html' %}
{% load static %}

{% block title %}
    Green Deal Annotation - Timeline
{% endblock %}

{% block head_inject %}
    <link rel="stylesheet" href="{% static 'css/timeline.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
            integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block main %}
    <main>
        <div class="container bg-light rounded mt-2">
            <div class="row">
                <div class="col">
                    <h2>Timeline</h2>
                    <p>
                        This timeline extracts all records from the European Green Deal documents that contain a date
                        and sorts them in ascending order. In the left box, the number of results is displayed at the top.
                        Below that, you can set various filters, such as specific documents or date boxes to limit the
                        start and end period of the found dates in the search.
                    </p>
                </div>
            </div>
            <div class="row">
                <!-----------------------------------FILTER-PANEL------------------------------------------->
                <div class="col-4">
                    <div id="Filter" class="col-md-4-de fixed-sidebar-de">
                        <div class="d-flex flex-column">
                        <div id="number_entries"></div>
                        <!--  hier werden die Container für die einzelnen Filterparts aufgesetzt
                        und die select-Optionen mit den möglichen Optionen aus der Datenbank befüllt -->
                        <label for="doc_name">Document Name</label>
                        <select class="js-example-basic-multiple" id="doc_name" onchange="get_dropdown_value()"
                                name="doc_name" multiple="multiple">
                            {% for doc in doc_names_filter %}
                                <option value="{{ doc }}">{{ doc }}</option>
                            {% endfor %}
                        </select>
                        <label for="start_date">Start Year</label>
                        <select onchange="get_dropdown_value()" id="start_date" class="js-example-basic-single"
                                name="start_date">
                            {% for year in year_filter %}
                                <option value="{{ year|slice:':4' }}"> {{ year }} </option>
                            {% endfor %}
                        </select>
                        <label for="end_date">End Year</label>
                        <select onchange="get_dropdown_value()" id="end_date" class="js-example-basic-single"
                                name="end_date">
                            {% for year in year_filter %}
                                <option value="{{ year|slice:':4' }}"> {{ year }} </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-primary" id="submit_filter" onclick="filter_url()">
                            Submit
                        </button>
                        <button type="button" class="btn btn-warning" id="reset" onclick="reset()"> Reset</button>
                        </div>
                    </div>
                </div>
                <!-----------------------------------TIMELINE------------------------------------------->
                <div class="col-8">
                    <div id="timeline">
                        <ul id="dates">
                            <!-- unsere komplette Timeline wird durch dieses Jinja Template erstellt;
                            dafür werden alle Einträge in der Datenbank durchlaufen -->
                            {% for col in data %}
                                <li>
                                    <span class="date"> {{ col.isodate }} </span>
                                    <p class="sentence"> {{ col.docsentence }} </p>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block footer_script %}
<script>
    $(document).ready(function () {
        $('.js-example-basic-single').select2();
        $('.js-example-basic-multiple').select2();
    });

window.onload = function() {
    $('#start_date').val(String({{ start_year }}));
    $('#end_date').val(String({{ end_year }}));
    /*$('#doc_name').val(['1', '2']); TODO*/
};

/********************************FILTERUNG*UND*WEITERLEITUNG***************************************/

    // Anzahl der Einträge
    document.getElementById("number_entries").textContent=("{{ data|length }}");

    // Zieht sich die ausgewählten Werte im Dropdown und schreibt sie in ein dictionary
    var filter_values = {};

    function get_dropdown_value() {

        filter_values["doc_name"] = $(".js-example-basic-multiple").select2("val");
        filter_values["start_date"] = document.getElementById('start_date').value;
        filter_values["end_date"] = document.getElementById('end_date').value;
    }

    // Encoded die ausgewählten Filterwerte (dict) in einen str, baut eine URL 
    // in der der str als Query mitgegeben wird und leitet den User auf die Seite (View) weiter
    function filter_url(){

        var str = [];
        for(var p in filter_values){
           str.push(encodeURIComponent(p) + "=" + encodeURIComponent(filter_values[p]));
        }

        str = "?" + str.join("&") + "#timeline";
        window.location = str;
    }
        
    // Reset Button, löscht die ausgewählten Filter und die Werte aus dem Dictionary,
    // leitet anschließend auf die Seite (View) mit den ungefilterten Daten
    function reset(){
        window.location = "?doc_name=&start_date=&end_date=#timeline"
    }
</script>
{% endblock %}
